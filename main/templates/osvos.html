{% extends 'base.html' %}
{% load static %}
{% block content %}

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Photovle{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css'%}">
    <script src="{% static 'bootstrap/css/bootstrap.min.css'%}"></script>

    <style>
        /* html css init */
        html,
        body,
        div,
        span,
        applet,
        object,
        iframe,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p,
        blockquote,
        pre,
        a,
        abbr,
        acronym,
        address,
        big,
        cite,
        code,
        del,
        dfn,
        em,
        img,
        ins,
        kbd,
        q,
        s,
        samp,
        small,
        strike,
        strong,
        sub,
        sup,
        tt,
        var,
        b,
        u,
        i,
        center,
        dl,
        dt,
        dd,
        ol,
        ul,
        li,
        fieldset,
        form,
        label,
        legend,
        table,
        caption,
        tbody,
        tfoot,
        thead,
        tr,
        th,
        td,
        article,
        aside,
        canvas,
        details,
        embed,
        figure,
        figcaption,
        footer,
        header,
        hgroup,
        menu,
        nav,
        output,
        ruby,
        section,
        summary,
        time,
        mark,
        audio,
        video {
            margin: 0;
            padding: 0;
            border: 0;
            font: inherit;
            vertical-align: baseline;
        }

        /* HTML5 display-role reset for older browsers */
        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        hgroup,
        menu,
        nav,
        section {
            display: block;
        }

        body {
            line-height: 1;
        }

        ol,
        ul {
            list-style: none;
        }

        blockquote,
        q {
            quotes: none;
        }

        blockquote:before,
        blockquote:after,
        q:before,
        q:after {
            content: '';
            content: none;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        body {
            background-image: url('/static/image/background.png');
            background-repeat: no-repeat;
            background-size: cover;
            overflow: hidden;
        }

        .logo {
            display: flex;
            height: 52px;
            margin-top: 40px;
            margin-left: 50px;
            margin-bottom: 18px;
        }

        .canvas-body {

            width: 100vw;
            height: calc(100vh - 115px);
            background-color: blue;
            display: flex;
            background: #FFFFFF 0% 0% no-repeat padding-box;
            border: 1px solid #707070;
            opacity: 1;
        }

        .control-bar {
            width: 300px;
            /* width:400px; */
            min-width: 300px;
            max-width: 300px;
            height: 100%;
            background: #E9E9E9 0% 0% no-repeat padding-box;
            opacity: 1;

        }

        .control-bar-option-area {
            width: 100%;
            height: 30px;
            border-top: 1px solid #707070;
            border-bottom: 1px solid #707070;
            opacity: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-right: 2px;

        }

        .control-bar-option-area>img {
            width: 30px;
            height: 30px;
            display: block;
            padding: 4px;
        }

        .control-bar-option-area>img:hover {
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);
        }


        #step1 {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-bottom: 50px;
        }

        #step1>img {
            height: 90px;
            margin-bottom: 12px;
        }

        #step1>p {
            color: #707070;
            opacity: 1;
            text-align: left;
            font: normal normal normal 16px/18px Segoe UI;
            display: block;
            cursor: default;
            margin-bottom: 12px;
        }

        button {
            background: #708AE8 0% 0% no-repeat padding-box;
            border-radius: 7px;
            opacity: 1;
            color: #FFFFFF;
            text-align: center;
            border: 0;
            width: 160px;
            padding: 4px 0 4px 0;
        }

        .input-file [type="file"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0 none;

        }

        .input-file .file-label {
            display: inline-block;
            cursor: pointer;
            height: 28px;
            line-height: 28px;
            text-align: center;

            background: #708AE8 0% 0% no-repeat padding-box;
            border-radius: 7px;
            opacity: 1;
            color: #FFFFFF;
            text-align: center;
            border: 0;
            width: 160px;

        }

        .input-file .file-name {
            width: 300px;
            background: #f5f5f5;
            height: 27px;
            line-height: 26px;
            text-indent: 5px;
            border: 1px solid #bbb;
        }

        .file-focus {
            outline: 1px dotted #d2310e;
        }

        #step2 {
            /* background-color: palegoldenrod; */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .label-add {
            width: 100%;
            display: flex;
            outline: none;
            background-color: greenyellow;
            justify-content: flex-end;
        }

        .label-add>input {
            width: 100px;
        }

        .label-add>input:focus {
            outline: none;
        }

        .label-add>button {
            width: 100px;
        }

        select {
            width: 100%;
            margin-left: 16px;
        }

        .infomation-area {
            /* background-color: pink; */
            padding: 12px;
        }

        .infomation-area>h3 {
            font-size: 18px;
            font-weight: bold;
            color: #707070;
            margin: 0 0 8px 0;
        }

        .infomation-area li {
            display: flex;
            line-height: 26px;
            font-size: 16px;
        }


        .infomation-area li>span {
            width: 94px;
            text-align: right;
        }


        .infomation-area li p {
            padding-left: 14px;
            font-weight: bold;
            width: 153px;
            text-overflow: ellipsis;
            white-space: nowrap;
            word-break: break-all;
        }

        .edit-label-name {
            width: calc(100% - 94px);
            display: flex;
            justify-content: space-between;
        }

        .edit-bar {
            width: 100%;
            height: 100%;
        }

        #image-area {
            height: 100%;
        }

        #image-list {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            padding: 24px 0;
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: scroll;
            padding-left: 4px;
            padding-bottom: 500px;
            background-color: #E9E9E9;
        }


        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background-color: #e0e0e0;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }

        #image-list>li {
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 126px;

            margin-bottom: 12px;
            margin-left: 6px;
            margin-right: 6px;
        }

        .image-item {
            display: inline-block;
            cursor: pointer;
        }

        #image-list>li:hover {
            font-weight: bold;
        }

        #image-list>li:active {
            font-weight: bold;
            color: #708AE8;
        }

        #image-list>li>p {
            margin-top: 2px;
            display: inline-flex;
            justify-content: center;
        }

        #image-list canvas {
            display: inline-block;
        }

        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal_body {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 400px;
            height: 200px;
            padding: 40px;
            text-align: center;
            background-color: rgb(255, 255, 255);
            border-radius: 10px;
            box-shadow: 0 2px 3px 0 rgba(34, 36, 38, 0.15);
            transform: translateX(-50%) translateY(-50%);
        }

        .title {
            height: 40px;
            font-size: 20px;
            display: flex;
            cursor: default;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;

        }

        .btn-open-popup {
            color: #708AE8;
            cursor: pointer;
            padding: 0px;
            height: 20px;
            margin-top: 4px;
        }

        .edit-label-name>img:hover {
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);
        }

        #label_name {
            margin-right: 10px;
        }

        .preview {
            display: flex;
            cursor: default;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .preview>p {
            width: 166px;
        }

        .preview input {
            outline: none;
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid #707070;
            /* margin-left: 12px; */
            padding-left: 4px;
            width: 100%;
        }

        .model-control {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .model-control button {
            width: 50px;
            padding: 2px 0;
            height: 30px;
        }


        .model-control>button:first-child {
            background-color: #707070;
            margin-right: 8px;
        }

        #imgViewer {
            border: 1px solid black;
        }

        #drawArea {
            border: 1px solid red;
        }

        #toolbara {
            width: 100%;
            height: 40px;
            padding: 10px;
            background-color: #2f2f2f;
            color: white;
            display: flex;
            align-items: center;

        }

        .radcontrol {
            width: 26px;
            height: 20px;
            background-color: #4f4f4f;
            display: inline-block;
            text-align: center;
            cursor: pointer;
        }
        .radcontrol:hover{
            color: #708AE8;
        }

        #rad {
            margin-right: 10px;
        }

        #colors>nav{
            margin: 0 4px;
            
        }

        .swatch {
            width: 20px;
            height: 20px;
            border-radius: 10px;
            box-shadow: inset 0px 2px 0px rgba(255, 255, 255, 0.5), 0px 2px 2px rgba(0, 0, 0, 0.5);
            display: inline-block;
            margin-left: 5px;
            margin-bottom: 50px;
            background-color: cyan;
        }

        .swatch.active {
            border: 2px solid white;
            box-shadow: inset 0px 1px 2px rgba(0, 0, 0, 0.5);
        }

        #save {
            
            /* width: 50px; */
            margin-right: 0px;
        }

        #save:hover {
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);

        }

        #my-eraser {
            /* background-color: #4f4f4f; */
            /* background-color: red; */
            /* width: 50px; */
            
            margin-right:0px;
        }

        #my-eraser:hover {
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);
        }


        #clear {
            filter: white;
            padding: 5px;
            /* margin-right:0px; */
        }

        #clear:hover {
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);
        }

        .draw-canvas{
            position: absolute; 
            z-index: 2; 
        }
    </style>
    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
</head>

<body>

    <div class="canvas-body">
        <div class="control-bar">

            <!-- step1 -->
            <div id='step1'>
                <div class="step1" id="step1">
                    <img src="/static/image/icon_camera.png" onclick="">
                    <p>편집할 동영상이 없습니다.</p>
                    <p>Canvas 화면</p>


                    <div class="input-file">
                        <label for="upload_video" class="file-label">파일 업로드</label>
                        <input id="upload_video" type="file" accept="video/mp4,video/mkv, video/x-m4v,video/*">
                    </div>
                </div>
            </div>

            <!-- step2 -->
            <div class="step2" id="step2" style="display: none;">
                <video id="video" style="display:none;"></video>

                <div class="infomation-area" style="cursor:default;">
                    <h3>Information</h3>
                    <ul>
                        <li>
                            <span>File Name : </span>
                            <p id="file_name"></p>
                        </li>

                        <li>
                            <span>Object : </span>
                            <div class="edit-label-name">
                                <p id="label_name"></p>
                                <img src="/static/image/icon_edit.svg" class="btn-open-popup">
                            </div>
                        </li>

                        <li>
                            <span>Total Frame : </span>
                            <p id="file_frame">0</p>
                        </li>

                        <li>
                            <span>Now Frame : </span>
                            <p id="label_now"></p>
                        </li>

                        <li>
                            <span>Size : </span>
                            <p id="file_size"></p>
                        </li>

                        <li>
                            <span>Type : </span>
                            <p id="file_type"></p>
                        </li>
                    </ul>
                </div>

                <div class="label-add">
                    <select disabled style="display: none;"></select>
                </div>

                <!-- 여러 설정 바 -->
                <div class="control-bar-option-area">
                    <img src="/static/image/icon_images.svg" id="divide_video">
                    <img src="/static/image/icon_train_data.svg" onclick="">
                    <img src="/static/image/icon_all_download.svg" onclick="">
                    <img src="/static/image/icon_video2.svg" onclick="">
                    

                </div>

                <!-- 이미지 프레임 목록 -->
                <div id="image-area">
                    <ul id="image-list"></ul>
                </div>
            </div>

        </div>

        <!-- Object 수정 모달 -->
        <div class="modal">
            <div class="modal_body">
                <div class="title">
                    <h2>Object Label Title</h2>
                </div>

                <div class="content">
                    <div class="preview">
                        <p>Label Name : </p>
                        <input type="text" id="label_tag" placeholder="입력해주세요.">

                    </div>
                    <div class="model-control">
                        <button type="button" class="close-area">취소</button>
                        <button type="button" onclick="define_tag();">확인</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var isDivideVideo = false;
            var nowImage;
            var nowDrawNum = 'canvas-0';
            let drawFrames = {};
            let openkey;
            let savelabel;
            let tmpcanvas, tmpframe;


            // 1. Object 이름 정의 및 변경 함수 (ex. cat Label)
            function define_tag() {
                const label = document.getElementById("label_tag").value;

                const fileName = document.querySelector("#label_name");
                fileName.textContent = label;
                savelabel = label;
                const modal = document.querySelector('.modal');
                modal.style.display = "none"
            }

            // 2. 사용자 업로드 영상 불러오기 (ex. demo_cat.mp4 -> 각 frame-idx)
            const elImage = document.querySelector("#upload_video");
            elImage.addEventListener("change", (evt) => {
                const file = evt.target.files[0];
                var video = document.getElementById("video");
                var width, height;

                // 1) Information 정보 추가 
                const fileName = document.querySelector("#file_name");
                fileName.textContent = file['name'];

                const fileSize = document.querySelector("#file_size");
                fileSize.textContent = file['size'] + " byte";

                const fileType = document.querySelector("#file_type");
                fileType.textContent = file['type'];


                // 2) 비디오 화면에 추가하기
                //   - 인자로 File객체를 받으며, 해당 file의 고유 URL 정보 생성하고 반환
                const videourl = URL.createObjectURL(file);
                document.getElementById("step1").style.display = 'none';
                document.getElementById("step2").style.display = 'block';

                // 3) 영상 분리하기
                const frames = [];
                const select = document.querySelector("select");
                // const canvas = document.getElementById("drawing");

                const canvas = document.getElementById("imgViewer");
                const ctx = canvas.getContext("2d");
                tmpcanvas = canvas;

                // ratataca
                // const drawCanvas = document.getElementById("drawArea");
                // const drawCtx = drawCanvas.getContext("2d");
                // drawCanvas.width = 1280;
                // drawCanvas.height = 720;

                // drawCtx.strokeStyle = 'black';
                // drawCtx.lineWidth = '30';
                // drawCtx.lineCap = ctx.lineJoin = 'round';
                // bErasing = false;
                // console.log("now : ", bErasing);


                // 4) 분할 Icon 클릭시
                const button = document.getElementById("divide_video");
                button.onclick = async (evt) => {
                    // (1) Object 이름 설정 여부 확인
                    // console.log(document.querySelector("#label_name").textContent)
                    // if (document.querySelector("#label_name").textContent == "") {
                    //     alert("레이블링의 object를 정의해주세요.");
                    //     return;
                    // }

                    if (window.MediaStreamTrackProcessor) {
                        isDivideVideo = true;
                        let stopped = false;
                        const track = await getVideoTrack();

                        const processor = new MediaStreamTrackProcessor(track);
                        const reader = processor.readable.getReader();
                        readChunk();

                        // (2) 각각 이미지들 Tag로 만들기
                        function readChunk() {
                            reader.read().then(async ({ done, value }) => {
                                if (value) {
                                    const bitmap = await createImageBitmap(value);
                                    const index = frames.length;
                                    frames.push(bitmap);

                                    //  - 이미지 리스트 내 ID 값, 실제 해당하는 이미지
                                    select.append(new Option("Frame #" + (index + 1), index));

                                    const imageListUl = document.getElementById("image-list");
                                    const imageItem = document.createElement("li");
                                    imageItem.setAttribute("id", "frame-" + (index + 1));
                                    imageItem.setAttribute("class", "image-item");
                                    imageItem.onclick = image_click;

                                    const imageCanvas = document.createElement("canvas");
                                    imageCanvas.width = 120;
                                    imageCanvas.height = 100;

                                    const imageId = document.createElement("p");
                                    imageId.textContent = "frame-" + (index + 1);
                                    var imgjson = new Object();
                                    imgjson.points = [];
                                    imgjson.dot = 0;
                                    

                                    // ***** Dict 만드는 곳
                                    const newDrawFrame = document.createElement('canvas');
                                    const newDrawCtx = newDrawFrame.getContext("2d");
                                    
                                    drawFrames[`${imageId.textContent}`] = newDrawFrame

                                    const imageCtx = imageCanvas.getContext("2d");
                                    imageCtx.drawImage(bitmap, 0, 0, 120, 100);

                                    // - 사이드바 이미지 리스트
                                    imageItem.append(imageCanvas);
                                    imageItem.append(imageId);
                                    imageListUl.append(imageItem);

                                    // console.log(imageItem);
                                    // console.log(drawFrames);

                                    value.close();

                                    // - Information bar - Total Frame의 값
                                    const fileTotalFram = document.querySelector("#file_frame");
                                    fileTotalFram.textContent = index + 1;
                                }
                                if (!done && !stopped) {
                                    readChunk();
                                } else {
                                    select.disabled = false;
                                }
                            });
                            button.onclick = (evt) => stopped = true;
                        }
                    } else {
                        console.error("your browser doesn't support this API yet");
                    }
                };

                // 3. select tag 선택 될 때 화면 전환
                select.onchange = (evt) => {
                    const frame = frames[select.value];
                    canvas.width = frame.width;
                    canvas.height = frame.height;
                    ctx.drawImage(frame, 0, 0);
                };

                // 4. 영상 이미지 분리를 위한 재생 함수
                async function getVideoTrack() {
                    video.crossOrigin = "anonymous";
                    video.src = videourl;
                    document.body.append(video);

                    await video.play();
                    const [track] = video.captureStream().getVideoTracks();
                    video.onended = (evt) => track.stop();
                    return track;
                }

                // 5. Frame-idx 가 클릭 되었을 때
                function image_click() {
                    ctx.beginPath();
                    var firstX, firstY;
                    var X, Y;
                    var attribute = this.getAttribute('id')
                    var tt = new Array(attribute);
                    openkey = tt[0];

                    if (nowImage != null) {
                        nowImage.style.color = 'black';
                        nowImage.style.fontWeight = 400;
                    }

                    // 1) 이미지 선택 되었을 때 frame-idx text bold 및 색 변경
                    nowImage = document.getElementById(openkey);
                    nowImage.style.color = '#708AE8';
                    nowImage.style.fontWeight = 600;

                    // 2) Information bar - Now Frame 값 (ex. Now Frame : frame-2)
                    const fileNow = document.querySelector("#label_now");
                    fileNow.textContent = openkey;
                    console.log(nowImage);

                    // 3) canvas 태그에 각 이미지 그리기
                    const frame = frames[attribute.split('-')[1]];
                    tmpframe = frame;
                    canvas.width = frame.width;
                    canvas.height = frame.height;
                    ctx.drawImage(frame, 0, 0);
                    console.log("1. frame : ", frame);

                    var frameNum = attribute.split("-")[1];
                    nowDrawNum = "canvas-" + frameNum;

                    console.log("Draw Frame : ", drawFrames, " Attribute : ", attribute);
                    // 4) canvas 태그 관련된 초기화
                    const drawCanvas = drawFrames[attribute];
                    drawCanvas.className = "draw-canvas";
                    drawCanvas.setAttribute('id', nowDrawNum);
                    const drawCtx = drawCanvas.getContext("2d");
                    drawCanvas.width = frame.width;
                    drawCanvas.height = frame.height;

                    drawCtx.strokeStyle = 'black';
                    drawCtx.lineWidth = '30';
                    drawCtx.lineCap = ctx.lineJoin = 'round';
                    bErasing = false;

                    const tmp = document.getElementById('edit-area');
                    tmp.removeChild(tmp.childNodes[tmp.childNodes.length - 1])
                    tmp.appendChild(drawCanvas);

                    console.log("2. drawCanvas", drawCanvas);
                    //=============================================================//
                    var canvas2 = document.getElementById("canvas-" + frameNum);
                    var context = canvas2.getContext('2d');
                    var radius = 5;
                    var dragging = false;
                    var bErasing = false;

                    context.beginPath();
                    context.rect(0, 0, canvas2.width, canvas2.height);
                    context.fillStyle = 'rgba(255, 0, 0, 0.2)';
                    context.fill();
                    context.beginPath();

                    context.lineWidth = radius * 2;

                    var putPoint = function (e) {
                        if (dragging) {
                            context.lineTo(e.offsetX, e.offsetY);
                            context.stroke();
                            context.beginPath();
                            context.arc(e.offsetX, e.offsetY, radius, 0, Math.PI * 2);
                            context.fill();
                            context.beginPath();
                            if (bErasing == true) {
                                context.globalCompositeOperation = "destination-out";
                            } else {
                                context.globalCompositeOperation = "source-over";
                            }
                            context.moveTo(e.offsetX, e.offsetY);
                            
                            // context.lineTo(e.pageX ,e.pageY);
                            // context.stroke();
                            // context.lineTo(e.offsetX, e.offsetY);
                            // context.stroke();
                            // context.beginPath();
                            // context.arc(e.offsetX, e.offsetY, radius, 0, Math.PI*2);
                            // context.fill();
                            // context.beginPath();
                            // context.moveTo(e.offsetX, e.offsetY);
                        }
                    }

                    var engage = function (e) {
                        dragging = true;
                        putPoint(e);
                    }

                    var disengage = function () {
                        dragging = false;
                        context.beginPath();
                    }

                    canvas2.addEventListener('mousedown', engage);
                    canvas2.addEventListener('mouseup', disengage);
                    canvas2.addEventListener('mousemove', putPoint);

                    var setRadius = function (newRadius) {
                        if (newRadius < minRad) newRadius = minRad;
                        else if (newRadius > maxRad) newRadius = maxRad;
                        radius = newRadius;
                        context.lineWidth = radius * 2;
                        radSpan.innerHTML = radius;
                    }

                    var minRad = 1,
                        maxRad = 40,
                        defaultRad = 15,
                        interval = 5,
                        radSpan = document.getElementById('radval'),
                        decRad = document.getElementById('decrad'),
                        incRad = document.getElementById('incrad');

                    decRad.addEventListener('click', function () {
                        setRadius(radius - interval);
                    });
                    incRad.addEventListener('click', function () {
                        setRadius(radius < interval ? interval : radius + interval);
                    });

                    setRadius(defaultRad);

                         //////////////////////////////////////////////////////

                    var colors = ['black', 'pink', 'red', 'yellow', 'green', 'blue']; //Color array to select from
                    /*Handles the creation of color*/
                    document.getElementById('colors').innerHTML = '';
                    
                    for (var i = 0, n = colors.length; i < n; i++) {
                        var swatch = document.createElement('nav');
                        swatch.className = 'swatch';
                        swatch.style.backgroundColor = colors[i];
                        swatch.addEventListener('click', setSwatch);
                        
                        document.getElementById('colors').appendChild(swatch);
                    }
                    /*set color*/
                    function setColor(color) {
                        context.fillStyle = color;
                        context.strokeStyle = color;
                        var active = document.getElementsByClassName('active')[0];
                        if (active) {
                            active.className = 'swatch';
                        }
                    }
                    function setSwatch(e) {
                        bErasing = false;
                        //identify swatch
                        var swatch = e.target;
                        //set color
                        setColor(swatch.style.backgroundColor);
                        //give active class
                        swatch.className += ' active';
                    }
                    setSwatch({ target: document.getElementsByClassName('swatch')[0] }); //set default swatch

                        //////////////////////////////////////

                    var button = document.getElementById('save');
                    button.addEventListener('click', saveImage);

                    function saveImage(el) {
                        console.log('download');
                        bErasing = true;
                        // const canvas2 = document.getElementById('drawArea');
                        var canvas2 = document.getElementById("canvas-" + frameNum);
                        const link = document.createElement('a');
                        link.download = 'download.png';
                        link.href = canvas2.toDataURL();
                        link.click();
                        link.delete;
                    };

                    var buttonclear = document.getElementById('clear');
                    buttonclear.addEventListener('click', clearImage);

                    function clearImage() {
                        var currentFillStyle = context.fillStyle;
                        context.clearRect(0, 0, canvas2.width, canvas2.height);
                        context.rect(0, 0, canvas2.width, canvas2.height);
                        context.fillStyle = "rgba(255, 0, 0, 0%)";
                        context.fill();
                        context.beginPath();
                        context.fillStyle = currentFillStyle;
                        context.strokeStyle = currentFillStyle;
                    };

                    function eraserImage() {
                        console.log('eraser');
                        bErasing = true;
                    };                    
                    //=============================================================//


                    // 4) 원본 
                    // const drawCanvas = document.getElementById("drawArea");
                    // const drawCtx = drawCanvas.getContext("2d");
                    // drawCanvas.width = frame.width;
                    // drawCanvas.height = frame.height;

                    // drawCtx.strokeStyle = 'black';
                    // drawCtx.lineWidth = '30';
                    // drawCtx.lineCap = ctx.lineJoin = 'round';
                    // bErasing = false;

                    console.log(drawFrames);
                };

            });

        </script>

        <div class="edit-bar" >
            <div id="toolbara">
                <div id="rad">
                    Radius <span id="radval">1</span>
                    <div id="decrad" class="radcontrol"> - </div>
                    <div id="incrad" class="radcontrol"> + </div>
                </div>

                <div id="colors"></div>
                <img src="/static/image/icon_eraser.svg" id="my-eraser"  onclick="eraserImage()" style="height: 30px; margin: 0 3px 0 6px;">
                <img src="/static/image/icon_all_draw_delete.svg" id="clear" style="height: 34px; margin: 0 3px 0 3px;">
                <img src="/static/image/icon_downloads.svg" id="save" style="height: 30px; margin: 0 3px 0 3px;">
            </div>
            
            <div class="edit-bar" id='edit-area' style="position: relative;">    
                <canvas id="imgViewer" style="position: absolute; z-index: 1;"></canvas>
                <!-- <canvas id="drawArea" style="position: absolute; z-index: 2; "></canvas>             -->
            </div>
        </div>

        <script>
            // var canvas = document.getElementById('drawArea');
            // var context = canvas.getContext('2d');
            // var radius = 5;
            // var dragging = false;
            // var bErasing = false;

            // context.beginPath();
            // context.rect(0, 0, canvas.width, canvas.height);
            // context.fillStyle = 'rgba(255, 0, 0, 0.2)';
            // context.fill();
            // context.beginPath();

            // context.lineWidth = radius * 2;

            // var putPoint = function (e) {
            //     if (dragging) {
            //         context.lineTo(e.offsetX, e.offsetY);
            //         context.stroke();
            //         context.beginPath();
            //         context.arc(e.offsetX, e.offsetY, radius, 0, Math.PI * 2);
            //         context.fill();
            //         context.beginPath();
            //         if (bErasing == true) {
            //             context.globalCompositeOperation = "destination-out";
            //         } else {
            //             context.globalCompositeOperation = "source-over";
            //         }
            //         context.moveTo(e.offsetX, e.offsetY);
                    
            //         // context.lineTo(e.pageX ,e.pageY);
            //         // context.stroke();
            //         // context.lineTo(e.offsetX, e.offsetY);
            //         // context.stroke();
            //         // context.beginPath();
            //         // context.arc(e.offsetX, e.offsetY, radius, 0, Math.PI*2);
            //         // context.fill();
            //         // context.beginPath();
            //         // context.moveTo(e.offsetX, e.offsetY);
            //     }
            // }

            // var engage = function (e) {
            //     dragging = true;
            //     putPoint(e);
            // }

            // var disengage = function () {
            //     dragging = false;
            //     context.beginPath();
            // }

            // canvas.addEventListener('mousedown', engage);
            // canvas.addEventListener('mouseup', disengage);
            // canvas.addEventListener('mousemove', putPoint);

            // var setRadius = function (newRadius) {
            //     if (newRadius < minRad) newRadius = minRad;
            //     else if (newRadius > maxRad) newRadius = maxRad;
            //     radius = newRadius;
            //     context.lineWidth = radius * 2;
            //     radSpan.innerHTML = radius;
            // }

            // var minRad = 1,
            //     maxRad = 40,
            //     defaultRad = 15,
            //     interval = 5,
            //     radSpan = document.getElementById('radval'),
            //     decRad = document.getElementById('decrad'),
            //     incRad = document.getElementById('incrad');

            // decRad.addEventListener('click', function () {
            //     setRadius(radius - interval);
            // });
            // incRad.addEventListener('click', function () {
            //     setRadius(radius < interval ? interval : radius + interval);
            // });

            // setRadius(defaultRad);

            // //////////////////////////////////////////////////////

            // var colors = ['black', 'pink', 'red', 'yellow', 'green', 'blue']; //Color array to select from
            // /*Handles the creation of color*/
            // for (var i = 0, n = colors.length; i < n; i++) {
            //     var swatch = document.createElement('nav');
            //     swatch.className = 'swatch';
            //     swatch.style.backgroundColor = colors[i];
            //     swatch.addEventListener('click', setSwatch);
            //     document.getElementById('colors').appendChild(swatch);
            // }
            // /*set color*/
            // function setColor(color) {
            //     context.fillStyle = color;
            //     context.strokeStyle = color;
            //     var active = document.getElementsByClassName('active')[0];
            //     if (active) {
            //         active.className = 'swatch';
            //     }
            // }
            // function setSwatch(e) {
            //     bErasing = false;
            //     //identify swatch
            //     var swatch = e.target;
            //     //set color
            //     setColor(swatch.style.backgroundColor);
            //     //give active class
            //     swatch.className += ' active';
            // }
            // setSwatch({ target: document.getElementsByClassName('swatch')[0] }); //set default swatch

            // //////////////////////////////////////

            // var button = document.getElementById('save');
            // button.addEventListener('click', saveImage);

            // function saveImage(el) {
            //     console.log('download');
            //     bErasing = true;
            //     // const canvas = document.getElementById('drawArea');
            //     var canvas = document.getElementById('drawArea');
            //     const link = document.createElement('a');
            //     link.download = 'download.png';
            //     link.href = canvas.toDataURL();
            //     link.click();
            //     link.delete;
            // };

            // var buttonclear = document.getElementById('clear');
            // buttonclear.addEventListener('click', clearImage);

            // function clearImage() {
            //     var currentFillStyle = context.fillStyle;
            //     context.clearRect(0, 0, canvas.width, canvas.height);
            //     context.rect(0, 0, canvas.width, canvas.height);
            //     context.fillStyle = "rgba(255, 0, 0, 0%)";
            //     context.fill();
            //     context.beginPath();
            //     context.fillStyle = currentFillStyle;
            //     context.strokeStyle = currentFillStyle;
            // };

            // function eraserImage() {
            //     console.log('eraser');
            //     bErasing = true;
            // };


        </script>

    </div>

    <script>
        const modal = document.querySelector('.modal');
        const btnOpenPopup = document.querySelector('.btn-open-popup');
        btnOpenPopup.addEventListener(
            'click', () => {
                if (isDivideVideo) {
                    alert("영상을 이미지로 분할하여 Object의 이름을 변경할 수 없습니다.")
                    return;
                }
                modal.style.display = 'block';
            });

        const closeBtn = modal.querySelector(".close-area")
        closeBtn.addEventListener("click", e => {
            modal.style.display = "none"
        })
    </script>
</body>

</html>
{% endblock %}