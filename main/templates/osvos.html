{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Photovle{% endblock %}</title>
    <linkz rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css'%}">
    <script src="{% static 'bootstrap/css/bootstrap.min.css'%}"></script>

    <style>
        body{
            background-image: url('/static/image/background.png');
            background-repeat: no-repeat;
            background-size: cover;
        }
        .logo{
            display:flex;
            height:52px;
            margin-top:40px;
            margin-left:50px;
        }
        .canvas-body{
            margin-top:18px;
            width:100vw;
            height : calc(100vh - 115px);
            background-color:blue;
            display:flex;
            background: #FFFFFF 0% 0% no-repeat padding-box;
            border: 1px solid #707070;
            opacity: 1;
        }

        .control-bar{
            width:390px;
            height:100%;
            background: #E9E9E9 0% 0% no-repeat padding-box;
            opacity: 1;

        }
        .control-bar-option-area{
            width:100%;
            height:30px;
            border-bottom: 1px solid #707070;
            opacity: 1;
            display: flex;
            justify-content:flex-end;
            align-items:center;
            margin-right: 2px;
            
        }
        .control-bar-option-area>img{
            width:30px;
            height:30px;
            display:block;
            padding: 4px;
        }

        .control-bar-option-area>img:hover{
            filter: invert(61%) sepia(18%) saturate(6443%) hue-rotate(202deg) brightness(95%) contrast(92%);
        }

        .image-viewer{
            width:100%;
            height:100%;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            padding-bottom: 50px;
            
        }

        .image-viewer>img{
            height:90px;
            margin-bottom:12px;
        }

        .image-viewer>p{
            color: #707070;
            opacity: 1;
            text-align: left;
            font: normal normal normal 16px/18px Segoe UI;
        }
        .image-viewer button{
            background: #708AE8 0% 0% no-repeat padding-box;
            border-radius: 7px;
            opacity: 1;
            color: #FFFFFF;
            text-align: center;
            border:0;
            width: 160px;
            padding: 4px 0 4px 0;
        }
        
        .input-file [type="file"] {
            position: absolute;
            width: 1px;
            height: 1px; 
            padding: 0; 
            margin: -1px; 
            overflow: hidden; 
            clip: rect(0, 0, 0, 0); 
            border: 0 none; 
            
        }

        .input-file .file-label { 
            display: inline-block; 
            height: 28px; 
            line-height: 28px; 
            text-align: center; 

            background: #708AE8 0% 0% no-repeat padding-box;
            border-radius: 7px;
            opacity: 1;
            color: #FFFFFF;
            text-align: center;
            border:0;
            width: 160px;
            
        } 
        
        .input-file .file-name { 
            width: 300px; 
            background: #f5f5f5; 
            height: 27px; 
            line-height: 26px; 
            text-indent: 5px; 
            border: 1px solid #bbb; 
        } 
        
        .file-focus { 
            outline: 1px dotted #d2310e; 
        }
        
        
        /* .input-file [type="file"] { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0 none; } .input-file .file-label { display: inline-block; min-width: 53px; height: 27px; line-height: 24px; padding: 0 10px; border-radius: 2px; font-size: 13px; background-color: #333; color: #fff; text-align: center; } .input-file .file-name { width: 300px; background: #f5f5f5; height: 27px; line-height: 26px; text-indent: 5px; border: 1px solid #bbb; } 접근성 탭 포커스 스타일 .file-focus { outline: 1px dotted #d2310e;  */
        
        


        .edit-bar{
            width: 100%;
            height:100%;
        }

        video,canvas {
            max-width: 100%
        }

    </style>
</head>

<body>

    <div>
        <img class="logo" src="/static/image/찐로고.png" onclick="location.href='{% url 'main:home' %}'">
    </div>
    <div class="canvas-body">
        <div class="control-bar">
            <div class="control-bar-option-area">
                <img src="/static/image/icon_check.svg" onclick="">
                <img src="/static/image/icon_trash_can.svg" onclick="">
            </div>

            <div class='image-viewer'>
                <img src="/static/image/icon_camera.png" onclick="">
                <p>편집할 동영상이 없습니다.</p>

                <div class="input-file"> 
                    <!-- <input type="text" readonly="readonly" class="file-name" /> -->
                    <label for="upload_video" class="file-label">파일 업로드</label> 
                    <input type="file" name="upload_video" id="upload_video" class="file-upload"/> 
                </div>
                <video id="video"></video>



                <button>start</button>
                <select disabled>
                </select>
                <canvas></canvas>
                
                <script>
                    // ##### 원본 : 영상 불러오기
                    const elImage = document.querySelector("#upload_video");
                    elImage.addEventListener("change", (evt) => {
                        const file = evt.target.files[0];
                        const video = document.getElementById("video");

                        console.log("hello")
                        console.log(file)

                        // 비디오 화면에 추가하기
                        // 인자로 File객체를 받으며, 해당 file의 고유 URL 정보 생성하고 반환한다.
                        const videourl = URL.createObjectURL(file); 
                        console.log(videourl)
                        // video.setAttribute("src", videourl); 
                        // video.play()

                        // create instance of video reader
                    });
                </script>

                

                <script>
                    // const decoder = new VideoDecoder({
                    //     output: onFrame, // the callback to handle all the VideoFrame objects
                    //     error: e => console.error(e),
                    // });
                    // decoder.configure(config); // depends on the input file, your demuxer should provide it
                    // demuxer.start((chunk) => { // depends on the demuxer, but you need it to return chunks of video data
                    //     decoder.decode(chunk); // will trigger our onFrame callback  
                    // })

                    const frames = [];
                    const button = document.querySelector("button");
                    const select = document.querySelector("select");
                    const canvas = document.querySelector("canvas");
                    
                    const ctx = canvas.getContext("2d");

                    button.onclick = async(evt) => {
                        console.log("hi");
                        if (window.MediaStreamTrackProcessor) {
                            let stopped = false;
                            const track = await getVideoTrack();
                            const processor = new MediaStreamTrackProcessor(track);
                            const reader = processor.readable.getReader();
                            readChunk();

                            function readChunk() {
                            reader.read().then(async({ done, value }) => {
                                if (value) {
                                const bitmap = await createImageBitmap(value);
                                const index = frames.length;
                                frames.push(bitmap);
                                select.append(new Option("Frame #" + (index + 1), index));
                                
                                const imageListUl = document.getElementById("image-list");
                                const imageItem = document.createElement("li");
                                const imageCanvas = document.createElement("canvas");
                                
                                const imageCtx = imageCanvas.getContext("2d");
                                imageCanvas.width = 50;
                                imageCanvas.height = 50;
                                imageCtx.drawImage(bitmap, 0, 0);

                                imageItem.append(imageCanvas);
                                imageListUl.append(imageItem);
                                console.log(imageItem);
                                console.log(imageListUl);

                                value.close();
                                }
                                if (!done && !stopped) {
                                readChunk();
                                } else {
                                select.disabled = false;
                                }
                            });
                            }
                            button.onclick = (evt) => stopped = true;
                            button.textContent = "stop";
                        } else {
                            console.error("your browser doesn't support this API yet");
                        }
                    };

                    select.onchange = (evt) => {
                        const frame = frames[select.value];
                        canvas.width = frame.width;
                        canvas.height = frame.height;
                        ctx.drawImage(frame, 0, 0);
                    };

                    async function getVideoTrack() {
                        const video = document.createElement("video");
                        video.crossOrigin = "anonymous";
                        video.src = "https://upload.wikimedia.org/wikipedia/commons/a/a4/BBH_gravitational_lensing_of_gw150914.webm";
                        document.body.append(video);
                        await video.play();
                        const [track] = video.captureStream().getVideoTracks();
                        video.onended = (evt) => track.stop();
                        return track;
                    }

                    

                </script>

                <!-- <form onsubmit="return Validate(this);">
                    File: <input type="file" name="Video file" /><br />
                    <input type="submit" value="Submit" />
                </form> -->


            </div>
        </div>

        <div class="edit-bar">
            <!-- <canvas id="canvas-img" style="height: 300px; width: 300px; background-color: red;"></canvas> -->
            <!-- <canvas id="canvas-img"></canvas> -->
            <ul id="image-list"></ul>
        </div>

    </div>    

    {% block content %}
    {% endblock %}
</body>

</html>